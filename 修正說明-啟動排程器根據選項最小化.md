# 修正：啟動排程器時根據選項執行最小化

## ? 修正內容

### 問題描述
按下"啟動排程器"按鈕時，沒有檢查"最小化至系統夾"選項，導致即使勾選了該選項，視窗也不會自動最小化到托盤。

### 正確行為

**情況 1：勾選"最小化至系統夾" + 點擊"啟動排程器"**
1. 啟動排程器 ?
2. 自動最小化程式 ?
3. 隱藏到系統托盤 ?
4. 顯示氣泡通知 ?

**情況 2：未勾選"最小化至系統夾" + 點擊"啟動排程器"**
1. 啟動排程器 ?
2. 視窗保持顯示 ?

**情況 3：排程器運行中 + 勾選"最小化至系統夾"**
1. 立即最小化並隱藏到托盤 ?

**情況 4：排程器未運行 + 勾選"最小化至系統夾"**
1. 只記錄選項，不執行最小化 ?
2. 等到點擊"啟動排程器"時才最小化 ?

## ?? 修改的方法

### 1. `btnToggleScheduler_Click` - 啟動排程器按鈕

**修改後**：
```csharp
private void btnToggleScheduler_Click(object? sender, EventArgs e)
{
    if (_scheduler.IsRunning)
    {
        _scheduler.Stop();
        btnToggleScheduler.Text = "啟動排程器";
        lstLog.Items.Insert(0, $"[時間] 排程器已停止");
    }
    else
    {
        _scheduler.Start();
        btnToggleScheduler.Text = "停止排程";
        lstLog.Items.Insert(0, $"[時間] 排程器已啟動");
        
        // ? 新增：如果勾選了"最小化至系統夾"，則自動最小化並隱藏
        if (chkMinToTray.Checked)
        {
            WindowState = FormWindowState.Minimized;
            ShowInTaskbar = false;
            Hide();
            lstLog.Items.Insert(0, $"[時間] 已最小化到托盤");
            _trayIcon?.ShowBalloonTip(2000, "排程器已啟動", 
                "視窗已最小化到系統托盤\n排程器執行中", ToolTipIcon.Info);
        }
    }
    UpdateTrayTextAndIcon();
}
```

### 2. `chkMinToTray_CheckedChanged` - 最小化選項勾選

**修改後**：
```csharp
private void chkMinToTray_CheckedChanged(object sender, EventArgs e)
{
    // ? 修改：只有當排程器正在運行時，才立即最小化
    if (chkMinToTray.Checked && _scheduler.IsRunning)
    {
        WindowState = FormWindowState.Minimized;
        ShowInTaskbar = false;
        Hide();
        
        lstLog.Items.Insert(0, $"[時間] 已最小化到托盤");
        _trayIcon?.ShowBalloonTip(2000, "已最小化", 
            "視窗已最小化到系統托盤\n排程器執行中", ToolTipIcon.Info);
        
        UpdateTrayTextAndIcon();
    }
}
```

## ?? 完整使用流程

### 流程 A：先勾選選項，再啟動排程器

1. **勾選"最小化至系統夾"**
   - ? 選項被記錄
   - ? 視窗保持顯示（因為排程器未運行）

2. **點擊"啟動排程器"**
   - ? 排程器啟動
   - ? 視窗自動最小化
   - ? 隱藏到系統托盤
   - ? 顯示氣泡通知："排程器已啟動"

### 流程 B：先啟動排程器，再勾選選項

1. **點擊"啟動排程器"**
   - ? 排程器啟動
   - ? 視窗保持顯示

2. **勾選"最小化至系統夾"**
   - ? 視窗立即最小化
   - ? 隱藏到系統托盤
   - ? 顯示氣泡通知："已最小化"

### 流程 C：不勾選選項，只啟動排程器

1. **點擊"啟動排程器"**
   - ? 排程器啟動
   - ? 視窗保持顯示（因為選項未勾選）

2. **可以在視窗中查看排程執行狀態**

## ?? 邏輯總結

### 最小化的兩個觸發條件

**條件 1：啟動排程器時**
```
IF (點擊啟動排程器 AND 選項已勾選)
THEN 啟動排程器 + 最小化到托盤
```

**條件 2：勾選選項時**
```
IF (勾選選項 AND 排程器運行中)
THEN 立即最小化到托盤
```

## ? 測試驗證

### 測試 1：先勾選後啟動
- 勾選"最小化至系統夾"
- 點擊"啟動排程器"
- **預期**：排程器啟動 + 視窗消失到托盤

### 測試 2：先啟動後勾選
- 點擊"啟動排程器"
- 勾選"最小化至系統夾"
- **預期**：排程器啟動視窗保持 + 勾選後立即最小化

### 測試 3：只勾選不啟動
- 勾選"最小化至系統夾"
- (不點擊啟動排程器)
- **預期**：視窗保持顯示

### 測試 4：不勾選只啟動
- 點擊"啟動排程器"
- (不勾選最小化選項)
- **預期**：排程器啟動 + 視窗保持顯示

## ?? 修正完成

現在"啟動排程器"按鈕會正確根據"最小化至系統夾"選項的狀態來決定是否自動最小化視窗！

? **建置狀態**：成功  
? **智能聯動**：啟動排程器時檢查選項狀態  
? **即時響應**：勾選選項時檢查排程器狀態
