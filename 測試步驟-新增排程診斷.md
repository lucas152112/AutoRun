# 測試步驟 - 新增排程功能診斷

## 現在已新增的日誌功能

程式已經添加了非常詳細的日誌追蹤，會記錄：

1. **建構函式**: Form1 初始化過程
2. **BindingList 變化**: 每當 _items 集合變化時的事件
3. **Form Load**: 載入設定檔的過程
4. **新增按鈕**: 清除輸入欄位的過程
5. **加入/更新按鈕**: 完整的新增/更新流程
6. **Grid 選擇變更**: SelectionChanged 事件
7. **清除輸入**: ClearInputs 方法

## 快速測試步驟

### 1. 啟動程式

觀察執行紀錄應該會看到：
```
=== Form1 建構函式開始 ===
設定資料綁定
綁定完成 - _items.Count: 0, DataSource: 已設定
=== Form1 建構函式完成 ===
=== Form1_Load 開始 ===
Storage.LoadAsync 完成, 載入 X 個項目
...
=== Form1_Load 完成 ===
```

### 2. 點擊「新增」按鈕

應該看到：
```
btnNew_Click - 開始
btnNew_Click - 清除前 _selected = ...
dgvSchedules_SelectionChanged - Rows.Count: X, SelectedRows.Count: 0
清除 _selected (無選擇)
ClearInputs - 清空輸入欄位
ClearInputs - 完成
btnNew_Click - 完成, _items.Count = X
```

**檢查點**: 
- 輸入欄位應該全部清空
- 「每天」應該被勾選
- 其他星期選項應該被禁用（灰色）

### 3. 輸入排程資料

- **名稱**: 測試排程
- **程式**: 選擇任何 .exe 檔案（例如：C:\Windows\notepad.exe）
- **參數**: 留空或輸入任意參數
- **時間**: 使用預設或調整
- **星期**: 保持「每天」勾選

### 4. 點擊「加入/更新」按鈕

這是最關鍵的步驟！應該看到類似這樣的日誌：

```
=== btnAddUpdate_Click 開始 ===
收集資料 - 名稱: '測試排程', 程式: 'C:\Windows\notepad.exe', 時間: 09:00:00, 星期數: 7
_selected = null
驗證通過
新增模式 - 建立新項目 (ID: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)
新增前 _items.Count = 0
BindingList.ListChanged - Type: ItemAdded, Index: 0, Count: 1    ← 這個很重要！
新增後 _items.Count = 1
呼叫 _binding.ResetBindings 前 - Grid.Rows.Count = 0
呼叫 _binding.ResetBindings 後 - Grid.Rows.Count = 1    ← 這個很關鍵！
呼叫 dgvSchedules.Refresh 後 - Grid.Rows.Count = 1
_items 內容:
  [0] 測試排程 - 09:00 - 一,二,三,四,五,六,日
尋找項目索引: 0
已選取 Grid 第 0 列
dgvSchedules_SelectionChanged - Rows.Count: 1, SelectedRows.Count: 1
選中項目: 測試排程
開始儲存, 項目數: 1
儲存成功
=== btnAddUpdate_Click 結束 ===
```

### 5. 檢查結果

**成功的標誌**:
- ? Grid 中顯示了新增的排程
- ? 可以看到項目名稱、程式、時間、星期
- ? 日誌顯示「儲存成功」
- ? `Grid.Rows.Count` 從 0 變成 1

**失敗的標誌**:
- ? Grid 仍然是空的
- ? `Grid.Rows.Count` 仍然是 0
- ? 日誌中有錯誤訊息

## 關鍵診斷點

如果問題仍然發生，請特別注意這幾個數值：

### A. BindingList.ListChanged 事件有沒有觸發？

```
BindingList.ListChanged - Type: ItemAdded, Index: 0, Count: 1
```

- **有看到**: _items 集合確實增加了項目
- **沒看到**: 項目沒有被正確加入 _items

### B. Grid.Rows.Count 的變化

```
呼叫 _binding.ResetBindings 前 - Grid.Rows.Count = 0
呼叫 _binding.ResetBindings 後 - Grid.Rows.Count = ?    ← 關鍵！
```

- **如果變成 1**: 資料綁定正常，項目應該顯示在 Grid 中
- **如果還是 0**: 資料綁定有問題，需要檢查綁定設定

### C. _items.Count 的變化

```
新增前 _items.Count = 0
新增後 _items.Count = 1
```

- **如果有增加**: 項目成功加入集合
- **如果沒增加**: 新增邏輯有問題

## 如果 Grid 還是空的

請將執行紀錄的內容**完整複製**並檢查：

1. 從「=== btnAddUpdate_Click 開始 ===」
2. 到「=== btnAddUpdate_Click 結束 ===」
3. 特別注意上面提到的三個關鍵診斷點

根據日誌內容，我們可以準確定位問題所在：

- **如果 BindingList.ListChanged 沒觸發** → 新增邏輯有問題
- **如果觸發了但 Grid.Rows.Count 沒變** → 資料綁定有問題
- **如果 Grid.Rows.Count 有變但看不到** → UI 更新有問題

## 額外測試

測試完新增後，也可以測試：

1. **選取項目**: 點擊 Grid 中的項目，輸入欄位應該顯示該項目的資料
2. **更新項目**: 修改資料後點擊「加入/更新」
3. **刪除項目**: 選取項目後點擊「刪除」

每個操作都會有詳細的日誌記錄。
