# 開發日誌 (Development Diary)

## 專案資訊

- **專案名稱**：AutoRun - 自動啟動排程工具
- **開發目標**：替代 Windows 內建排程功能，提供更簡單易用的排程管理介面
- **.NET 版本**：.NET 8.0
- **C# 版本**：12.0
- **UI 框架**：Windows Forms
- **開發環境**：Visual Studio 2022

---

## 2024-12-XX - 初版功能開發完成

### ?? 已完成功能

#### 核心功能
- ? 排程管理系統
  - 新增、編輯、刪除排程項目
  - 支援啟用/禁用個別排程
  - 排程項目自動儲存至 `setting.json`
  
- ? 排程器引擎
  - 使用 `System.Threading.Timer` 每 5 秒檢查排程
  - 分鐘級精度（HH:mm）
  - 支援星期選擇（週一至週日、每天）
  - 防止同一分鐘內重複執行
  - 支援多個排程同時執行

- ? 程式啟動功能
  - 使用 `ProcessStartInfo` 啟動外部程式
  - 支援命令列參數
  - 支援多種檔案格式（.exe, .bat, .cmd, .ps1）
  - 自動設定工作目錄

#### 使用者介面
- ? DataGridView 顯示排程列表
  - 欄位：啟用、名稱、程式、時間、週期
  - 自動調整欄寬（程式路徑使用剩餘空間）
  - 選取項目後自動載入至編輯欄位
  
- ? 輸入欄位智能狀態管理
  - 未選取時：所有欄位禁用
  - 點擊「新增」：啟用欄位並清空內容
  - 選取項目：啟用欄位並載入資料
  - 儲存後：自動禁用欄位

- ? 執行紀錄 (ListBox)
  - 即時顯示排程執行訊息
  - 顯示錯誤訊息
  - 新訊息插入頂部

#### 系統托盤功能
- ? 托盤圖示和選單
  - 右鍵選單：開啟視窗、啟動/停止排程器、退出
  - 雙擊托盤圖示恢復視窗
  - 托盤提示顯示詳細資訊
  
- ? 最小化至系統夾
  - 勾選選項 + 排程器運行中 → 立即最小化
  - 啟動排程器 + 已勾選選項 → 自動最小化
  - 從托盤恢復時保持選項狀態

- ? 氣泡通知
  - 最小化到托盤時顯示
  - 排程執行時顯示
  - 持續 2 秒自動消失

#### 設定功能
- ? 應用程式設定
  - 最小化至系統夾選項
  - 開機自動啟動選項
  - 設定保存至 `settings.json`
  
- ? 開機自動啟動
  - 修改 Windows 註冊表（HKEY_CURRENT_USER\Run）
  - 支援啟用/禁用

#### 資料持久化
- ? JSON 序列化儲存和載入
  - 排程項目：`setting.json`
  - 應用程式設定：`settings.json`
  - 非同步檔案操作
  - 錯誤處理機制

### ?? 已修正問題

#### 問題 1：最小化自動啟動排程器
**問題描述**：勾選"最小化至系統夾"時會自動啟動排程器，導致用戶無法單純隱藏視窗。

**解決方案**：
- 移除 `chkMinToTray_CheckedChanged` 中的自動啟動邏輯
- 改為：只有當排程器運行中時，勾選才立即最小化
- 文件：`修正說明-最小化不自動啟動排程.md`

#### 問題 2：啟動排程器不根據選項最小化
**問題描述**：按下"啟動排程器"按鈕時，即使勾選了"最小化至系統夾"，視窗也不會自動最小化。

**解決方案**：
- 在 `btnToggleScheduler_Click` 中加入檢查邏輯
- 如果 `chkMinToTray.Checked` 為 true，啟動後自動最小化
- 支援兩種操作順序：先勾選後啟動 / 先啟動後勾選
- 文件：`修正說明-啟動排程器根據選項最小化.md`

#### 問題 3：從托盤恢復時選項被重置
**問題描述**：從系統托盤恢復視窗時，"最小化至系統夾"選項會被自動取消勾選，導致用戶設定被覆蓋。

**解決方案**：
- 移除 `RestoreFromTray()` 中的 `chkMinToTray.Checked = false;`
- 保持用戶設定的狀態
- 確保設定正確保存和載入
- 文件：`修正說明-保持最小化選項狀態.md`

#### 問題 4：載入時顯示第一筆資料
**問題描述**：程式啟動時，DataGridView 會自動選取第一筆資料，導致輸入欄位被載入內容。

**解決方案**：
- 在 `Form1_Load` 中暫時移除 `SelectionChanged` 事件
- 載入完成後執行 `dgvSchedules.ClearSelection()`
- 清空並禁用輸入欄位
- 重新加入 `SelectionChanged` 事件

#### 問題 5：儲存後欄位未清空
**問題描述**：加入/更新排程後，編輯欄位仍顯示資料且可編輯。

**解決方案**：
- 在 `btnAddUpdate_Click` 儲存後執行清除動作
- `dgvSchedules.ClearSelection()`
- `DisableInputs()`
- `ClearInputs()`

### ?? 技術實現細節

#### SchedulerService.cs
```csharp
- 使用 System.Threading.Timer（每 5 秒觸發）
- TruncateToMinute：截斷至分鐘精度
- _lastFiredAtMinute：防止重複執行
- OnRun 事件：通知 UI 排程執行結果
- OnDebug 事件：通知 UI 偵錯訊息
```

#### Storage.cs
```csharp
- 非同步 JSON 序列化
- LoadAsync/SaveAsync：處理排程項目
- LoadSettingsAsync/SaveSettingsAsync：處理應用程式設定
- 錯誤處理：檔案不存在或讀取失敗時返回空物件
```

#### ScheduleItem.cs
```csharp
- Id：Guid 唯一識別碼
- TimeOfDay：TimeSpan 儲存時間
- Days：List<DayOfWeek> 儲存星期
- TimeDisplay：格式化顯示 HH:mm
- DaysDisplay：格式化顯示中文星期
- JsonIgnore：排除顯示屬性不序列化
```

#### Form1.cs 關鍵邏輯
```csharp
- InitializeComponent：設定 DataGridView 欄位
- Form1_Load：載入資料和設定
- ApplySettingsToUI：套用設定到 UI
- btnToggleScheduler_Click：智能聯動最小化
- chkMinToTray_CheckedChanged：條件最小化
- RestoreFromTray：保持設定狀態
```

### ?? 功能邏輯流程

#### 最小化功能的兩個觸發條件

**條件 1：啟動排程器時**
```
IF (點擊啟動排程器 AND chkMinToTray.Checked)
THEN 啟動排程器 + 最小化到托盤
```

**條件 2：勾選選項時**
```
IF (勾選選項 AND _scheduler.IsRunning)
THEN 立即最小化到托盤
```

#### 輸入欄位狀態管理

| 狀態 | 觸發事件 | 欄位狀態 | 按鈕狀態 |
|------|----------|----------|----------|
| 初始載入 | Form_Load | 禁用 + 清空 | 禁用 |
| 點擊新增 | btnNew_Click | 啟用 + 清空 | 啟用 |
| 選取項目 | SelectionChanged | 啟用 + 載入 | 啟用 |
| 儲存後 | btnAddUpdate_Click | 禁用 + 清空 | 禁用 |
| 刪除後 | btnDelete_Click | 禁用 + 清空 | 禁用 |

### ?? 文件說明

#### 技術文件
- `最小化功能實現說明.md` - 完整功能實現和使用指南
- `修正說明-最小化不自動啟動排程.md` - 問題分析和修正方案
- `修正說明-啟動排程器根據選項最小化.md` - 智能聯動實現
- `修正說明-保持最小化選項狀態.md` - 設定狀態保持機制

#### 開發文件
- `CHANGELOG.md` - 版本更新紀錄（已刪除，改用本文件）
- `Develop_Dairy.md` - 本文件，開發日誌

### ?? 開發工具和套件

- **IDE**：Visual Studio 2022
- **NuGet 套件**：
  - System.Text.Json（內建）- JSON 序列化
  - Microsoft.Win32.Registry（內建）- 註冊表操作

### ?? 已知限制

1. **排程精度**：分鐘級別（HH:mm），不支援秒級精度
2. **程式權限**：使用 `UseShellExecute = true`，可能受系統權限限制
3. **開機啟動範圍**：僅支援當前用戶（HKEY_CURRENT_USER）
4. **錯誤重試**：程式啟動失敗後不會自動重試
5. **日誌保存**：執行紀錄僅在記憶體中，不保存到檔案

### ?? 測試狀態

#### 功能測試
- ? 排程新增/編輯/刪除
- ? 排程執行（測試用簡單程式）
- ? 最小化至托盤
- ? 從托盤恢復
- ? 設定保存和載入
- ? 開機自動啟動（已測試）

#### 邊界測試
- ? 空排程列表
- ? 重複時間的多個排程
- ? 無效程式路徑
- ? 快速切換排程器狀態
- ? 設定檔案不存在

### ?? 使用場景範例

#### 場景 1：每天早上啟動應用程式
```
名稱：開啟工作軟體
程式：C:\Program Files\App\app.exe
參數：--auto-login
時間：09:00
週期：每天
啟用：?
```

#### 場景 2：週末執行備份腳本
```
名稱：週末備份
程式：D:\scripts\backup.bat
參數：
時間：02:00
週期：六、日
啟用：?
```

#### 場景 3：工作日提醒休息
```
名稱：休息提醒
程式：C:\Tools\reminder.exe
參數：--message "該休息了"
時間：10:30, 15:30
週期：一、二、三、四、五
啟用：?
```

### ?? 未來計劃

#### 短期計劃（v1.1）
- [ ] 加入排程執行歷史記錄（保存到檔案）
- [ ] 支援匯出/匯入排程設定（JSON 格式）
- [ ] 加入排程執行統計（成功/失敗次數）
- [ ] 支援程式執行超時設定

#### 中期計劃（v1.2）
- [ ] 支援更多時間設定選項
  - [ ] 間隔執行（每 N 分鐘/小時）
  - [ ] 一次性排程（指定日期時間）
  - [ ] 月份選擇（每月幾號）
- [ ] 支援程式執行輸出日誌記錄
- [ ] 支援排程依賴（A 執行完才執行 B）

#### 長期計劃（v2.0）
- [ ] 支援條件執行（檔案存在、網路連線等）
- [ ] 支援多語言介面（英文、日文）
- [ ] 支援自訂托盤圖示
- [ ] 支援遠端管理（透過網頁介面）
- [ ] 支援 PowerShell 腳本直接編輯

### ?? 效能資訊

- **記憶體使用**：約 30-50 MB（執行中）
- **CPU 使用**：低於 1%（閒置時）
- **排程檢查頻率**：每 5 秒
- **啟動時間**：< 1 秒
- **設定檔案大小**：< 10 KB（100 個排程）

### ?? 學習心得

#### 遇到的挑戰
1. **最小化邏輯**：一開始將功能混在一起，導致用戶體驗不佳
   - 解決：分離為獨立功能，加入智能聯動
   
2. **狀態管理**：視窗和排程器狀態需要同步
   - 解決：使用事件通知機制和統一的更新方法
   
3. **設定保存**：從托盤恢復時意外修改設定
   - 解決：移除不必要的狀態重置，保持用戶選擇

#### 技術收穫
1. **Windows Forms 進階技巧**
   - DataGridView 資料綁定
   - NotifyIcon 托盤功能
   - 動態控制項啟用/禁用
   
2. **非同步程式設計**
   - async/await 處理檔案 I/O
   - BeginInvoke 跨執行緒更新 UI
   
3. **設計模式**
   - 事件驅動架構
   - 資料持久化層分離
   - UI 和業務邏輯分離

### ?? 問題回報

如有任何問題或建議，請至 GitHub Issues 回報：
https://github.com/lucas152112/AutoRun/issues

---

## 版本歷史

### v1.0 - 2024-12-XX（初版）
- 基本排程管理功能
- 系統托盤整合
- 最小化和開機啟動功能
- 智能聯動機制
- 完整的設定保存和載入

---

**最後更新**：2024-12-XX  
**開發者**：lucas152112  
**授權**：待定
