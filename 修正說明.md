# 修正說明文件

## 修正項目

### 1. ? 加入/更新後，編輯區自動恢復為禁用狀態

**問題**：
- 點擊「加入/更新」後，編輯區仍然保持可編輯狀態
- 排程項目仍被選中

**修正**：
在 `btnAddUpdate_Click` 方法中，儲存成功後：
```csharp
// 加入/更新後，清除選擇並禁用輸入欄位
dgvSchedules.ClearSelection();
_selected = null;
DisableInputs();
ClearInputs();

lstLog.Items.Insert(0, $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] 排程項目已儲存");
```

**效果**：
- ? 清除 DataGridView 的選擇
- ? 清空 `_selected` 變數
- ? 禁用所有輸入欄位（變成灰色不可編輯）
- ? 清空輸入欄位內容
- ? 在執行紀錄中記錄儲存訊息

### 2. ? 改善最小化到系統托盤的行為

**問題**：
- 最小化後視窗沒有真正隱藏
- 不清楚排程器是否有執行
- 托盤提示訊息不夠明確

**修正 A - 立即隱藏視窗**：
```csharp
protected override void OnResize(EventArgs e)
{
    base.OnResize(e);
    if (WindowState == FormWindowState.Minimized && chkMinToTray.Checked)
    {
        // 立即隱藏視窗並移到系統托盤
        Hide();
        
        // 然後檢查排程器狀態...
    }
}
```

**修正 B - 顯示清楚的狀態訊息**：
```csharp
if (!_scheduler.IsRunning)
{
    _scheduler.Start();
    btnToggleScheduler.Text = "停止排程";
    lstLog.Items.Insert(0, $"[時間] 最小化到托盤 - 自動啟動排程器");
    _trayIcon?.ShowBalloonTip(2000, "自動啟動排程器", 
        "視窗已最小化到系統托盤\n排程器已自動啟動", ToolTipIcon.Info);
}
else
{
    lstLog.Items.Insert(0, $"[時間] 最小化到托盤 - 排程器已在運行中");
    _trayIcon?.ShowBalloonTip(2000, "已最小化", 
        "視窗已最小化到系統托盤\n排程器執行中", ToolTipIcon.Info);
}
```

**修正 C - 改善托盤圖示提示**：
```csharp
private void UpdateTrayTextAndIcon()
{
    if (_trayIcon == null) return;
    var running = _scheduler.IsRunning ? "執行中" : "已停止";
    var itemCount = _items.Count;
    var enabledCount = _items.Count(x => x.Enabled);
    
    _trayIcon.Text = $"排程器: {running}\n共 {itemCount} 個排程 ({enabledCount} 個啟用)";
    _menuToggleScheduler!.Text = _scheduler.IsRunning ? "停止排程器" : "啟動排程器";
}
```

**效果**：
- ? 視窗立即隱藏，只保留托盤圖示
- ? 托盤氣泡通知清楚顯示排程器狀態
- ? 托盤圖示提示顯示詳細資訊：
  - 排程器執行狀態
  - 總排程數量
  - 啟用的排程數量
- ? 執行紀錄清楚記錄操作

## 使用說明

### 加入/更新排程的新流程

1. **開始編輯**：
   - 點擊「新增」→ 輸入欄位啟用（白色可編輯）
   - 或選擇現有排程 → 自動載入資料

2. **填寫資料**：
   - 輸入名稱、選擇程式、設定時間等

3. **儲存**：
   - 點擊「加入/更新」
   - ? 排程項目儲存成功
   - ? 輸入欄位自動變成灰色（禁用）
   - ? 所有內容清空
   - ? DataGridView 的選擇被清除
   - ? 執行紀錄顯示「排程項目已儲存」

4. **繼續編輯**：
   - 點擊「新增」開始新的排程
   - 或點選 DataGridView 中的項目編輯現有排程

### 最小化到托盤的新體驗

1. **最小化前**：
   - 確保勾選「最小化自動啟動排程」（如果需要自動啟動）

2. **點擊最小化按鈕**：
   - 視窗立即消失
   - 工作列上的圖示也消失
   - 只保留系統托盤圖示

3. **托盤氣泡通知**：
   - 如果排程器未運行：
     ```
     標題：自動啟動排程器
     內容：視窗已最小化到系統托盤
          排程器已自動啟動
     ```
   - 如果排程器已運行：
     ```
     標題：已最小化
     內容：視窗已最小化到系統托盤
          排程器執行中
     ```

4. **托盤圖示資訊**（滑鼠停留顯示）：
   ```
   排程器: 執行中
   共 3 個排程 (2 個啟用)
   ```

5. **恢復視窗**：
   - 雙擊托盤圖示
   - 或右鍵選單 → 「開啟視窗」

6. **從托盤控制**：
   - 右鍵托盤圖示
   - 選擇「啟動排程器」或「停止排程器」
   - 選擇「退出」關閉程式

## 測試建議

### 測試 1: 加入/更新後的狀態

1. 點擊「新增」
2. 填寫排程資料
3. 點擊「加入/更新」
4. **驗證**：
   - [ ] 輸入欄位變成灰色（禁用）
   - [ ] 所有欄位內容清空
   - [ ] DataGridView 沒有選中任何項目
   - [ ] 執行紀錄顯示「排程項目已儲存」

### 測試 2: 最小化到托盤

1. 勾選「最小化自動啟動排程」
2. 確保排程器已停止（按鈕顯示「啟動排程器」）
3. 點擊視窗的最小化按鈕
4. **驗證**：
   - [ ] 視窗立即消失
   - [ ] 工作列沒有程式圖示
   - [ ] 系統托盤出現圖示
   - [ ] 顯示氣泡通知「自動啟動排程器」
   - [ ] 氣泡內容包含兩行文字

5. 滑鼠停留在托盤圖示上
6. **驗證**：
   - [ ] 顯示「排程器: 執行中」
   - [ ] 顯示排程數量和啟用數量

7. 雙擊托盤圖示
8. **驗證**：
   - [ ] 視窗恢復顯示
   - [ ] 按鈕顯示「停止排程」
   - [ ] 執行紀錄有相關記錄

### 測試 3: 排程器已運行時最小化

1. 點擊「啟動排程器」（按鈕變成「停止排程」）
2. 勾選「最小化自動啟動排程」
3. 點擊視窗的最小化按鈕
4. **驗證**：
   - [ ] 視窗立即消失
   - [ ] 顯示氣泡通知「已最小化」
   - [ ] 氣泡內容：「排程器執行中」
   - [ ] 托盤提示正確顯示狀態

## 常見問題

### Q: 為什麼加入/更新後輸入欄位會被禁用？
A: 這是為了保持一致的用戶體驗。完成編輯後回到「查看模式」，需要編輯時再點擊「新增」或選擇項目。

### Q: 如何再次編輯剛才加入的排程？
A: 在 DataGridView 中點選該排程項目，輸入欄位會自動啟用並載入資料。

### Q: 最小化後找不到程式了？
A: 程式已最小化到系統托盤（通常在右下角時鐘附近），雙擊托盤圖示即可恢復視窗。

### Q: 托盤提示的數字是什麼意思？
A: 
- 第一個數字：總排程數量
- 第二個數字（括號內）：已啟用的排程數量
- 例如「共 5 個排程 (3 個啟用)」表示有 5 個排程，其中 3 個已啟用

### Q: 如何確認排程器是否正在運行？
A: 查看以下任一指標：
- 主視窗按鈕顯示「停止排程」
- 托盤圖示提示顯示「排程器: 執行中」
- 執行紀錄有「排程器已啟動」訊息

## 改進效果總結

? **用戶體驗改善**：
- 編輯流程更清晰明確
- 最小化行為符合預期
- 狀態資訊一目了然

? **視覺回饋增強**：
- 托盤通知更詳細
- 輸入欄位狀態明確（可編輯/禁用）
- 執行紀錄完整記錄操作

? **操作流程優化**：
- 加入/更新後自動回到查看模式
- 最小化立即隱藏視窗
- 排程器狀態即時更新
