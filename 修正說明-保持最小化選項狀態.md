# 修正：保持"最小化至系統夾"選項的狀態

## ? 問題描述

### 錯誤行為
當從系統托盤恢復視窗時，"最小化至系統夾"選項會被自動取消勾選，導致：
1. 用戶原本保存的設定狀態被改變
2. 下次保存設定時，會覆蓋原本的設定（MinimizeToTray = false）
3. 用戶需要重新勾選選項

### 問題根源
在 `RestoreFromTray()` 方法中有這行代碼：
```csharp
chkMinToTray.Checked = false;  // ? 強制取消勾選
```

## ? 修正方案

### 修改內容
移除強制取消勾選的邏輯，保持用戶設定的狀態：

**修改前**：
```csharp
private void RestoreFromTray()
{
    Show();
    ShowInTaskbar = true;
    WindowState = FormWindowState.Normal;
    Activate();
    
    // ? 錯誤：強制取消勾選
    chkMinToTray.Checked = false;
}
```

**修改後**：
```csharp
private void RestoreFromTray()
{
    Show();
    ShowInTaskbar = true;
    WindowState = FormWindowState.Normal;
    Activate();
    
    // ? 正確：保持用戶的設定狀態
    // 不修改 chkMinToTray.Checked 的值
}
```

## ?? 完整流程說明

### 場景 1：勾選選項並保存

1. **用戶操作**：
   - 勾選"最小化至系統夾"
   - 點擊"存檔"或關閉程式

2. **設定保存**：
   ```json
   {
     "MinimizeToTray": true,
     "RunOnStartup": false
   }
   ```

3. **下次啟動**：
   - 載入設定：`chkMinToTray.Checked = true` ?
   - 選項保持勾選狀態 ?

### 場景 2：從托盤恢復視窗

**修正前的錯誤流程**：
1. 用戶從托盤恢復視窗
2. `chkMinToTray.Checked = false` ?
3. 用戶關閉程式
4. 保存 `MinimizeToTray = false` ?
5. 下次啟動時選項未勾選 ?

**修正後的正確流程**：
1. 用戶從托盤恢復視窗
2. `chkMinToTray.Checked` 保持原狀 ?
3. 用戶關閉程式
4. 保存 `MinimizeToTray = true` ?
5. 下次啟動時選項保持勾選 ?

## ?? 設定保存機制

### 保存時機
設定會在以下兩個時機保存：

**1. 手動保存（btnSave_Click）**：
```csharp
await Storage.SaveAsync(_items);
await Storage.SaveSettingsAsync(ReadSettingsFromUI());
```

**2. 程式關閉時（Form1_FormClosing）**：
```csharp
await Storage.SaveAsync(_items);
await Storage.SaveSettingsAsync(ReadSettingsFromUI());
```

### 讀取設定的方法
```csharp
private AppSettings ReadSettingsFromUI() => new AppSettings
{
    MinimizeToTray = chkMinToTray.Checked,  // 讀取 checkbox 當前狀態
    RunOnStartup = chkRunAtStartup.Checked
};
```

### 載入設定的方法
```csharp
private void ApplySettingsToUI()
{
    chkMinToTray.Checked = _settings.MinimizeToTray;  // 恢復 checkbox 狀態
    chkRunAtStartup.Checked = _settings.RunOnStartup;
    ApplyRunAtStartup(_settings.RunOnStartup);
    UpdateTrayTextAndIcon();
}
```

## ?? 使用場景對照

| 場景 | 修正前 | 修正後 |
|------|--------|--------|
| **勾選選項 → 關閉程式** | 保存 true ? | 保存 true ? |
| **重新啟動程式** | 選項已勾選 ? | 選項已勾選 ? |
| **最小化到托盤** | 選項已勾選 ? | 選項已勾選 ? |
| **從托盤恢復** | 選項變成未勾選 ? | 選項保持勾選 ? |
| **再次關閉程式** | 保存 false ? | 保存 true ? |
| **下次啟動** | 選項未勾選 ? | 選項已勾選 ? |

## ? 預期行為

### 正確的狀態保持
1. ? 用戶勾選"最小化至系統夾"
2. ? 狀態保存到 `settings.json`
3. ? 從托盤恢復視窗時，選項保持勾選
4. ? 關閉程式時，保存的仍是 `true`
5. ? 下次啟動時，選項自動勾選

### 功能正常運作
- ? 勾選選項 + 排程器運行中 → 立即最小化
- ? 勾選選項 + 點擊啟動排程器 → 自動最小化
- ? 從托盤恢復視窗 → 選項保持原狀
- ? 再次啟動排程器 → 如果選項仍勾選，會再次最小化

## ?? 測試驗證

### 測試 1：設定保存和載入

**步驟**：
1. 啟動程式
2. 勾選"最小化至系統夾"
3. 關閉程式
4. 重新啟動程式

**預期結果**：
- ? 重新啟動後，"最小化至系統夾"選項仍是勾選狀態

### 測試 2：從托盤恢復不改變狀態

**步驟**：
1. 啟動程式
2. 勾選"最小化至系統夾"
3. 啟動排程器（視窗最小化到托盤）
4. 從托盤恢復視窗
5. 檢查"最小化至系統夾"選項

**預期結果**：
- ? 選項保持勾選狀態

### 測試 3：多次恢復和最小化

**步驟**：
1. 勾選"最小化至系統夾"
2. 啟動排程器 → 最小化到托盤
3. 恢復視窗 → 選項仍勾選
4. 停止排程器
5. 再次啟動排程器 → 應該再次最小化到托盤

**預期結果**：
- ? 每次恢復後選項都保持勾選
- ? 再次啟動排程器時會自動最小化

### 測試 4：取消勾選並保存

**步驟**：
1. 從勾選狀態取消勾選
2. 關閉程式
3. 重新啟動程式

**預期結果**：
- ? 重新啟動後，選項為未勾選狀態

## ?? 設定文件範例

### settings.json（勾選時）
```json
{
  "MinimizeToTray": true,
  "RunOnStartup": false
}
```

### settings.json（未勾選時）
```json
{
  "MinimizeToTray": false,
  "RunOnStartup": true
}
```

## ?? 修正完成

現在"最小化至系統夾"選項的狀態會被正確保存和載入，不會因為從托盤恢復視窗而被意外改變！

### 關鍵改進
? **移除強制取消勾選**：恢復視窗時不修改選項狀態  
? **保持用戶設定**：尊重用戶的選擇  
? **設定持久化**：正確保存和載入設定  
? **邏輯一致**：功能行為符合用戶預期

---

**建置狀態**：? 成功  
**功能驗證**：? 待測試
