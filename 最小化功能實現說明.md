# 最小化至系統夾功能 - 最終實現說明

## ? 功能說明

### "最小化至系統夾" (chkMinToTray)
- **類型**：CheckBox（勾選框）
- **功能**：勾選後立即執行最小化並隱藏到系統托盤的動作
- **保存狀態**：是，會保存到 settings.json
- **恢復行為**：從托盤恢復視窗時，自動取消勾選
- **?? 重要**：**不會自動啟動排程器**，排程器需要透過"啟動排程器"按鈕手動控制

### "開機自動啟動" (chkRunAtStartup)
- **類型**：CheckBox（勾選框）
- **功能**：設定 Windows 開機時是否自動啟動此應用程式
- **保存狀態**：是，會保存到 settings.json
- **系統整合**：修改 Windows 註冊表

### "啟動排程器" (btnToggleScheduler)
- **類型**：Button（按鈕）
- **功能**：手動控制排程器的啟動和停止
- **狀態切換**：點擊後文字在"啟動排程器"和"停止排程"之間切換
- **獨立控制**：與"最小化至系統夾"功能完全獨立

## ?? 實現細節

### 1. 勾選"最小化至系統夾"時的行為

```csharp
private void chkMinToTray_CheckedChanged(object sender, EventArgs e)
{
    if (chkMinToTray.Checked)
    {
        // 1. 先最小化程式
        WindowState = FormWindowState.Minimized;
        
        // 2. 從工作列移除
        ShowInTaskbar = false;
        
        // 3. 隱藏視窗
        Hide();
        
        // 4. 記錄和顯示通知（不啟動排程器）
        lstLog.Items.Insert(0, $"[時間] 已最小化到托盤");
        
        var statusMsg = _scheduler.IsRunning ? "排程器執行中" : "排程器未啟動";
        _trayIcon?.ShowBalloonTip(2000, "已最小化", 
            $"視窗已最小化到系統托盤\n{statusMsg}", ToolTipIcon.Info);
        
        UpdateTrayTextAndIcon();
    }
}
```

### 2. 從托盤恢復時的行為

```csharp
private void RestoreFromTray()
{
    // 1. 顯示視窗
    Show();
    
    // 2. 恢復到工作列
    ShowInTaskbar = true;
    
    // 3. 恢復為正常窗口
    WindowState = FormWindowState.Normal;
    
    // 4. 啟動並置於最前面
    Activate();
    
    // 5. 自動取消勾選"最小化至系統夾"
    chkMinToTray.Checked = false;
}
```

### 3. 設定的保存與載入

**AppSettings.cs**:
```csharp
public class AppSettings
{
    public bool MinimizeToTray { get; set; }
    public bool RunOnStartup { get; set; }
}
```

**保存設定**:
```csharp
private AppSettings ReadSettingsFromUI() => new AppSettings
{
    MinimizeToTray = chkMinToTray.Checked,
    RunOnStartup = chkRunAtStartup.Checked
};
```

**載入設定**:
```csharp
private void ApplySettingsToUI()
{
    chkMinToTray.Checked = _settings.MinimizeToTray;
    chkRunAtStartup.Checked = _settings.RunOnStartup;
    ApplyRunAtStartup(_settings.RunOnStartup);
    UpdateTrayTextAndIcon();
}
```

## ?? 完整流程

### 場景 1：用戶勾選"最小化至系統夾"

1. **用戶操作**：勾選 checkbox
2. **觸發事件**：`chkMinToTray_CheckedChanged`
3. **程式行為**：
   - 視窗最小化
   - 工作列圖示消失
   - 只保留托盤圖示
   - 顯示氣泡通知（2秒）
4. **排程器狀態**：
   - **不會自動啟動或停止**
   - 保持原有狀態（運行中或未啟動）
   - 氣泡通知會顯示當前狀態
5. **設定保存**：
   - `MinimizeToTray = true`
   - 下次啟動時會載入此設定

### 場景 2：用戶從托盤恢復視窗

1. **用戶操作**：
   - 雙擊托盤圖示，或
   - 右鍵選單 → 開啟視窗
2. **觸發方法**：`RestoreFromTray()`
3. **程式行為**：
   - 視窗顯示
   - 工作列圖示恢復
   - 視窗置於最前面
   - **自動取消勾選** `chkMinToTray`
4. **設定變更**：
   - `MinimizeToTray = false`
   - 下次儲存時會更新

### 場景 3：程式重新啟動

1. **載入設定**：`_settings = await Storage.LoadSettingsAsync();`
2. **應用設定**：`ApplySettingsToUI();`
3. **結果**：
   - 如果上次是勾選狀態 → 勾選框顯示為已勾選
   - 如果上次是取消狀態 → 勾選框顯示為未勾選
4. **不會自動執行**：
   - 只是恢復 UI 狀態
   - 不會自動最小化到托盤

## ?? 設定檔案

**settings.json** (自動生成在程式目錄):
```json
{
  "MinimizeToTray": false,
  "RunOnStartup": true
}
```

## ?? 使用說明

### 獨立的三個功能

#### 1. 最小化至系統夾
- **操作**：勾選 checkbox
- **效果**：視窗立即最小化並隱藏到托盤
- **排程器**：不影響排程器狀態

#### 2. 啟動/停止排程器
- **操作**：點擊"啟動排程器"或"停止排程"按鈕
- **效果**：控制排程器的運行狀態
- **視窗**：不影響視窗顯示狀態

#### 3. 開機自動啟動
- **操作**：勾選"開機自動啟動"
- **效果**：Windows 開機時自動啟動應用程式
- **排程器**：應用程式啟動時，排程器不會自動運行

### 典型使用流程

**流程 A：背景運行排程**
1. 點擊「啟動排程器」→ 排程器開始運行
2. 勾選「最小化至系統夾」→ 視窗隱藏到托盤
3. 排程器在背景持續運行
4. 雙擊托盤圖示 → 恢復視窗查看狀態

**流程 B：只最小化不執行**
1. 不啟動排程器
2. 勾選「最小化至系統夾」→ 視窗隱藏到托盤
3. 排程器保持停止狀態
4. 需要時從托盤恢復視窗並手動啟動排程器

**流程 C：開機自動運行**
1. 勾選「開機自動啟動」
2. 重啟電腦
3. 應用程式自動啟動（視窗顯示）
4. 手動點擊「啟動排程器」
5. 可選：勾選「最小化至系統夾」隱藏視窗
