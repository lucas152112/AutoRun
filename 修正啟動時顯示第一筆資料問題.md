# 修正啟動時顯示第一筆資料問題

## 問題描述

程式啟動時，雖然已經實作了輸入欄位禁用功能，但輸入欄位仍然會顯示第一筆排程資料的內容（如名稱、程式路徑、時間等），這不符合預期的「啟動時應該完全空白」的需求。

## 問題原因

### 事件觸發順序

```
1. Form1_Load 開始執行
   ↓
2. 載入資料到 _items
   ↓
3. _binding.ResetBindings(false)  ← 觸發 DataGridView 更新
   ↓
4. DataGridView 自動選中第一列（預設行為）
   ↓
5. 觸發 dgvSchedules_SelectionChanged 事件
   ↓
6. LoadToInputs(item) 被呼叫
   ↓
7. 輸入欄位顯示第一筆資料 ?
   ↓
8. dgvSchedules.ClearSelection()  ← 太晚了，資料已經載入
   ↓
9. DisableInputs()  ← 只能禁用，但內容已經顯示
```

### 核心問題

**DataGridView 的 SelectionChanged 事件會在資料綁定時自動觸發**，即使我們在 `Form1_Load` 的最後呼叫 `ClearSelection()` 和 `DisableInputs()`，輸入欄位的內容已經被 `LoadToInputs()` 填入了。

## 解決方案

### 修改後的流程

```
1. Form1_Load 開始執行
   ↓
2. 暫時移除 SelectionChanged 事件處理器 ?
   ↓
3. 載入資料到 _items
   ↓
4. _binding.ResetBindings(false)
   ↓
5. DataGridView 更新（但不會觸發事件）?
   ↓
6. dgvSchedules.ClearSelection()
   ↓
7. ClearInputs() ← 清空所有輸入欄位 ?
   ↓
8. DisableInputs() ← 禁用輸入欄位 ?
   ↓
9. 重新加入 SelectionChanged 事件處理器 ?
   ↓
10. 啟動完成，輸入欄位空白且禁用 ?
```

### 程式碼修改

#### Before（有問題的版本）

```csharp
private async void Form1_Load(object? sender, EventArgs e)
{
    var loaded = await Storage.LoadAsync();
    _items.Clear();
    foreach (var i in loaded)
    {
        _items.Add(i);
    }
    
    _binding.ResetBindings(false);  // ← 這裡會觸發 SelectionChanged

    _settings = await Storage.LoadSettingsAsync();
    ApplySettingsToUI();
    ApplyToScheduler();

    dgvSchedules.ClearSelection();  // ← 太晚了
    _selected = null;
    DisableInputs();  // ← 只能禁用，但內容已載入
}
```

#### After（修正後的版本）

```csharp
private async void Form1_Load(object? sender, EventArgs e)
{
    // 暫時移除 SelectionChanged 事件處理，避免載入時觸發
    dgvSchedules.SelectionChanged -= dgvSchedules_SelectionChanged;
    
    var loaded = await Storage.LoadAsync();
    _items.Clear();
    foreach (var i in loaded)
    {
        _items.Add(i);
    }
    
    _binding.ResetBindings(false);

    _settings = await Storage.LoadSettingsAsync();
    ApplySettingsToUI();
    ApplyToScheduler();

    // 清除 Grid 的預設選擇，不顯示第一筆資料
    dgvSchedules.ClearSelection();
    _selected = null;
    
    // 清空輸入欄位內容 ← 新增
    ClearInputs();
    
    // 禁用所有輸入欄位，等待使用者按下「新增」或選擇項目
    DisableInputs();
    
    // 重新加入 SelectionChanged 事件處理 ← 新增
    dgvSchedules.SelectionChanged += dgvSchedules_SelectionChanged;
}
```

## 關鍵改進

### 1. 事件處理器的暫時移除

```csharp
// 移除事件
dgvSchedules.SelectionChanged -= dgvSchedules_SelectionChanged;

// ... 執行資料載入 ...

// 重新加入事件
dgvSchedules.SelectionChanged += dgvSchedules_SelectionChanged;
```

**優點**:
- 防止資料綁定時自動觸發事件
- 完全掌控事件的觸發時機
- 避免不必要的 UI 更新

### 2. 明確呼叫 ClearInputs()

```csharp
ClearInputs();
```

**作用**:
- 清空所有文字方塊
- 重設時間選擇器
- 重設核取方塊狀態
- 確保輸入欄位完全空白

### 3. 正確的執行順序

```
清除選擇 → 清空輸入 → 禁用欄位 → 重新啟用事件
```

## 測試驗證

### 測試案例 1: 啟動空白資料庫

**步驟**:
1. 刪除或清空 `setting.json`
2. 啟動程式

**預期結果**:
- ? Grid 為空
- ? 輸入欄位全部空白
- ? 輸入欄位全部禁用
- ? 「加入/更新」按鈕禁用

### 測試案例 2: 啟動有資料的資料庫

**步驟**:
1. 確保 `setting.json` 有多筆排程資料
2. 啟動程式

**預期結果**:
- ? Grid 顯示所有排程項目
- ? **沒有任何項目被選中**
- ? **輸入欄位完全空白**（不顯示第一筆）
- ? 輸入欄位全部禁用
- ? 「加入/更新」按鈕禁用

### 測試案例 3: 選擇項目後重新啟動

**步驟**:
1. 啟動程式（有資料）
2. 點選某一筆排程項目
3. 關閉程式
4. 重新啟動程式

**預期結果**:
- ? Grid 顯示所有排程項目
- ? **沒有任何項目被選中**（不記憶上次的選擇）
- ? **輸入欄位完全空白**
- ? 輸入欄位全部禁用

## 相關行為

### 使用者操作後的狀態

#### 1. 點擊「新增」按鈕
```
輸入欄位: 空白 + 預設值（時間 09:00，啟用?，每天?）
狀態: 啟用
Grid 選擇: 清除
```

#### 2. 點選 Grid 項目
```
輸入欄位: 該項目的資料
狀態: 啟用
Grid 選擇: 該項目被選中
```

#### 3. 刪除項目
```
輸入欄位: 空白
狀態: 禁用
Grid 選擇: 清除
```

#### 4. 提交後
```
輸入欄位: 剛提交的資料
狀態: 啟用
Grid 選擇: 剛提交的項目被選中
```

## 技術細節

### DataGridView 的預設行為

DataGridView 在以下情況會自動選擇第一列：
1. 資料源被設定或更新時
2. 呼叫 `ResetBindings()` 時
3. 資料列被新增時（如果之前沒有資料）

### 事件處理器的管理

```csharp
// 移除事件（使用 -= 運算子）
control.Event -= EventHandler;

// 加入事件（使用 += 運算子）
control.Event += EventHandler;
```

**注意事項**:
- 移除前必須確保事件已經加入
- 移除和加入必須使用相同的方法引用
- 在 `Form1` 建構函式中，事件是在 Designer 產生的 `InitializeComponent()` 中連接的

### ClearInputs() 方法的作用

```csharp
private void ClearInputs()
{
    txtName.Clear();              // 清空名稱
    txtExe.Clear();               // 清空程式路徑
    txtArgs.Clear();              // 清空參數
    dtpTime.Value = DateTime.Today.AddHours(9);  // 重設時間
    chkEnabled.Checked = true;    // 預設啟用
    chkEveryDay.Checked = true;   // 預設每天
    // ... 清除星期選項
}
```

## 優勢

### 1. 使用者體驗改善

**Before**:
```
啟動程式 → 看到第一筆資料 → 困惑「我在編輯嗎？」
```

**After**:
```
啟動程式 → 完全空白 → 清楚知道「我在瀏覽模式」
```

### 2. 操作流程更清晰

```
瀏覽模式（啟動）
    ↓
點擊「新增」或選擇項目
    ↓
編輯模式（可輸入）
    ↓
提交或取消
    ↓
回到瀏覽模式或保持編輯模式
```

### 3. 避免誤操作

- 使用者不會誤以為正在編輯第一筆資料
- 清楚區分「瀏覽」和「編輯」狀態
- 輸入欄位的狀態（啟用/禁用）明確表示目前模式

## 版本資訊

- **修正版本**: v1.2.1
- **修正日期**: 2025-01-20
- **修正檔案**: `Form1.cs`
- **相關功能**: 輸入欄位權限控制

## 相關文件

- `輸入欄位權限控制說明.md` - 輸入欄位權限控制的完整說明
- `輸入欄位權限控制實作總結.md` - 實作總結
- `diary.md` - 開發日誌

## 總結

透過暫時移除事件處理器並明確呼叫 `ClearInputs()`，我們成功解決了啟動時顯示第一筆資料的問題。現在程式啟動時會完全符合預期：

? Grid 顯示所有資料  
? 沒有任何項目被選中  
? 輸入欄位完全空白  
? 輸入欄位全部禁用  
? 使用者必須主動操作才能進入編輯模式  

這樣的設計更符合直覺，也避免了使用者的困惑和誤操作。
