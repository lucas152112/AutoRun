# 修正：最小化至系統夾不自動啟動排程器

## ? 原有錯誤行為

勾選"最小化至系統夾"時，程式會：
1. 最小化並隱藏到托盤 ?
2. **自動啟動排程器** ? (錯誤！)

這導致用戶無法單純地將視窗隱藏到托盤而不啟動排程。

## ? 修正後的正確行為

勾選"最小化至系統夾"時，程式會：
1. 最小化並隱藏到托盤 ?
2. **只記錄和顯示當前排程器狀態** ?
3. **不改變排程器狀態** ?

排程器的啟動和停止**只能**透過"啟動排程器"按鈕來控制。

## ?? 修改內容

### Form1.cs - `chkMinToTray_CheckedChanged` 方法

**修改前**：
```csharp
private void chkMinToTray_CheckedChanged(object sender, EventArgs e)
{
    if (chkMinToTray.Checked)
    {
        WindowState = FormWindowState.Minimized;
        ShowInTaskbar = false;
        Hide();
        
        // ? 錯誤：自動啟動排程器
        if (!_scheduler.IsRunning)
        {
            _scheduler.Start();
            btnToggleScheduler.Text = "停止排程";
            lstLog.Items.Insert(0, $"[時間] 最小化到托盤 - 自動啟動排程器");
            _trayIcon?.ShowBalloonTip(2000, "自動啟動排程器", 
                "視窗已最小化到系統托盤\n排程器已自動啟動", ToolTipIcon.Info);
        }
        else
        {
            lstLog.Items.Insert(0, $"[時間] 已最小化到托盤");
            _trayIcon?.ShowBalloonTip(2000, "已最小化", 
                "視窗已最小化到系統托盤\n排程器執行中", ToolTipIcon.Info);
        }
        
        UpdateTrayTextAndIcon();
    }
}
```

**修改後**：
```csharp
private void chkMinToTray_CheckedChanged(object sender, EventArgs e)
{
    if (chkMinToTray.Checked)
    {
        WindowState = FormWindowState.Minimized;
        ShowInTaskbar = false;
        Hide();
        
        // ? 正確：只記錄和顯示狀態，不啟動排程器
        lstLog.Items.Insert(0, $"[{DateTime.Now:yyyy-MM-dd HH:mm:ss}] 已最小化到托盤");
        
        var statusMsg = _scheduler.IsRunning ? "排程器執行中" : "排程器未啟動";
        _trayIcon?.ShowBalloonTip(2000, "已最小化", 
            $"視窗已最小化到系統托盤\n{statusMsg}", ToolTipIcon.Info);
        
        UpdateTrayTextAndIcon();
    }
}
```

## ?? 三個獨立功能的正確理解

### 1?? 最小化至系統夾 (chkMinToTray)
- **目的**：隱藏視窗到系統托盤
- **不影響**：排程器狀態
- **氣泡通知**：顯示當前排程器狀態（執行中/未啟動）

### 2?? 啟動排程器 (btnToggleScheduler)
- **目的**：控制排程器的啟動和停止
- **不影響**：視窗顯示狀態
- **按鈕文字**：動態顯示"啟動排程器"或"停止排程"

### 3?? 開機自動啟動 (chkRunAtStartup)
- **目的**：Windows 開機時自動啟動應用程式
- **不影響**：排程器狀態（啟動應用程式不等於啟動排程器）
- **系統整合**：修改 Windows 註冊表

## ?? 使用場景對照表

| 場景 | 視窗狀態 | 排程器狀態 | 操作步驟 |
|------|----------|------------|----------|
| **只想隱藏視窗** | 托盤 | 停止 | 勾選"最小化至系統夾" |
| **背景執行排程** | 托盤 | 運行中 | 1. 點擊"啟動排程器"<br>2. 勾選"最小化至系統夾" |
| **查看執行狀態** | 顯示 | 運行中 | 從托盤恢復視窗 |
| **停止排程但保持托盤** | 托盤 | 停止 | 從托盤選單點擊"停止排程器" |
| **開機自動啟動** | 顯示 | 停止 | 勾選"開機自動啟動"並重啟 |

## ? 測試驗證

### 測試 1：最小化不啟動排程

1. **前置條件**：排程器未啟動（按鈕顯示"啟動排程器"）
2. **操作**：勾選"最小化至系統夾"
3. **預期結果**：
   - ? 視窗隱藏到托盤
   - ? 氣泡通知顯示"排程器未啟動"
   - ? 排程器保持停止狀態
4. **驗證**：從托盤恢復視窗，按鈕應顯示"啟動排程器"

### 測試 2：最小化時排程器運行中

1. **前置條件**：先點擊"啟動排程器"（按鈕變成"停止排程"）
2. **操作**：勾選"最小化至系統夾"
3. **預期結果**：
   - ? 視窗隱藏到托盤
   - ? 氣泡通知顯示"排程器執行中"
   - ? 排程器保持運行狀態
4. **驗證**：從托盤恢復視窗，按鈕應顯示"停止排程"

### 測試 3：獨立控制排程器

1. **前置條件**：視窗已最小化到托盤，排程器未啟動
2. **操作**：右鍵托盤圖示 → 點擊"啟動排程器"
3. **預期結果**：
   - ? 排程器啟動
   - ? 視窗保持在托盤
   - ? 托盤提示更新為"排程器: 執行中"
4. **驗證**：從托盤恢復視窗，按鈕應顯示"停止排程"

## ?? 對比總結

| 項目 | 修改前 | 修改後 |
|------|--------|--------|
| **勾選最小化** | 自動啟動排程器 | 不影響排程器 |
| **排程器控制** | 可能被自動啟動 | 只能手動控制 |
| **氣泡通知** | 顯示"自動啟動排程器" | 顯示當前狀態 |
| **用戶困擾** | 無法單純隱藏視窗 | 可以自由選擇 |
| **功能獨立性** | 混在一起 | 清楚分離 |

## ?? 相關文件更新

- ? `Form1.cs` - 修正 `chkMinToTray_CheckedChanged` 方法
- ? `最小化功能實現說明.md` - 更新功能說明和使用指南
- ? 建置成功，無錯誤

## ?? 修正完成

現在"最小化至系統夾"和"啟動排程器"是兩個完全獨立的功能：

? **最小化至系統夾** = 控制視窗顯示  
? **啟動排程器** = 控制排程執行  
? **開機自動啟動** = 控制應用程式啟動

用戶可以自由組合這些功能，獲得最靈活的使用體驗！
