# 診斷日誌說明

## 已新增的日誌功能

程式現在會在「執行紀錄」（lstLog）中顯示詳細的操作日誌，包含時間戳記（精確到毫秒）。

### 日誌類型

1. **一般日誌**: `[HH:mm:ss.fff] 訊息內容`
2. **錯誤日誌**: `[HH:mm:ss.fff] ? 錯誤訊息`

### 追蹤的操作

#### Form Load (表單載入)
```
=== Form1_Load 開始 ===
Storage.LoadAsync 完成, 載入 X 個項目
  加入項目: 項目名稱
_binding.ResetBindings 完成
Grid.Rows.Count = X
設定預設輸入值
=== Form1_Load 完成 ===
```

#### 按下「新增」按鈕
```
btnNew_Click - 開始
btnNew_Click - 清除前 _selected = 項目名稱或null
btnNew_Click - 完成, _items.Count = X
ClearInputs - 清空輸入欄位
ClearInputs - 完成
```

#### 按下「加入/更新」按鈕
```
=== btnAddUpdate_Click 開始 ===
收集資料 - 名稱: 'XXX', 程式: 'YYY', 時間: HH:mm:ss, 星期數: N
_selected = 項目名稱或null
驗證通過/驗證失敗: 原因
新增模式 - 建立新項目 (ID: guid) 或 更新模式 - 更新項目
新增前 _items.Count = X
新增後 _items.Count = Y
呼叫 _binding.ResetBindings 前 - Grid.Rows.Count = X
呼叫 _binding.ResetBindings 後 - Grid.Rows.Count = Y
呼叫 dgvSchedules.Refresh 後 - Grid.Rows.Count = Y
_items 內容:
  [0] 項目名稱 - 時間 - 星期
尋找項目索引: X
已選取 Grid 第 X 列
開始儲存, 項目數: X
儲存成功
=== btnAddUpdate_Click 結束 ===
```

#### Grid 選擇變更
```
dgvSchedules_SelectionChanged - Rows.Count: X, SelectedRows.Count: Y
選中項目: 項目名稱 或 清除 _selected (無選擇)
```

## 測試步驟

### 測試新增功能

1. **啟動程式**
   - 觀察 Form Load 的日誌
   - 確認載入的項目數

2. **按下「新增」按鈕**
   - 應該看到：
     - `btnNew_Click - 開始`
     - `btnNew_Click - 清除前 _selected = ...`
     - `ClearInputs - 清空輸入欄位`
     - `ClearInputs - 完成`
     - `btnNew_Click - 完成, _items.Count = X`

3. **輸入排程資料**
   - 名稱: 測試排程
   - 程式: 選擇任何 .exe 檔案
   - 時間: 任意
   - 星期: 應該已經預設勾選「每天」

4. **按下「加入/更新」按鈕**
   - 觀察日誌中的詳細流程
   - 特別注意：
     - `收集資料` - 確認資料正確收集
     - `驗證通過` - 確認通過驗證
     - `新增前 _items.Count = X` 和 `新增後 _items.Count = Y` - Y 應該 = X + 1
     - `呼叫 _binding.ResetBindings 後 - Grid.Rows.Count = Y` - 應該 = _items.Count
     - `_items 內容:` - 列出所有項目
     - `儲存成功` - 確認儲存到檔案

5. **檢查 Grid**
   - Grid 應該顯示新增的項目
   - 如果沒有顯示，檢查日誌中 `Grid.Rows.Count` 的值

## 可能的問題與診斷

### 問題 1: 資料消失，Grid 沒有顯示

**觀察日誌中的這些關鍵點：**

1. `新增後 _items.Count = ?` - 如果這個值增加了，表示資料有加入集合
2. `呼叫 _binding.ResetBindings 後 - Grid.Rows.Count = ?` - 如果這個值是 0，表示綁定有問題
3. `_items 內容:` - 列出的項目數與 _items.Count 是否一致

**可能的原因：**

- 如果 `_items.Count` 增加但 `Grid.Rows.Count` 仍是 0 → **資料綁定問題**
- 如果驗證失敗 → **輸入資料有問題**（例如沒選星期）
- 如果儲存失敗 → **檔案權限問題**

### 問題 2: 按下新增後，欄位沒有清空或「每天」沒有勾選

**檢查日誌：**
- `ClearInputs - 清空輸入欄位` 是否有出現
- `ClearInputs - 完成` 是否有出現

### 問題 3: dgvSchedules_SelectionChanged 頻繁觸發

**觀察：**
- 每次操作後是否有意外的 SelectionChanged 事件
- 如果有，可能會影響 `_selected` 的狀態

## 將日誌匯出

如果需要將日誌提供給開發者診斷，可以：

1. 選取執行紀錄 ListBox 中的所有項目（Ctrl+A）
2. 複製（Ctrl+C）
3. 貼到文字檔案中

## 建議的診斷流程

1. 清空執行紀錄
2. 執行一次完整的新增操作
3. 複製所有日誌
4. 分析關鍵數值的變化

特別注意：
- `_items.Count` 的變化
- `Grid.Rows.Count` 的變化
- 是否有錯誤訊息（?）
